#!/bin/bash

# Application backup script
BACKUP_DIR="{{ app_home }}/backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="app_backup_${DATE}.tar.gz"

# Create backup directory if it doesn't exist
mkdir -p "$BACKUP_DIR"

# Create application backup
tar -czf "$BACKUP_DIR/$BACKUP_FILE" \
    -C "{{ app_home }}" \
    --exclude="venv" \
    --exclude="logs" \
    --exclude="backups" \
    --exclude="*.pyc" \
    --exclude="__pycache__" \
    app

# Log backup creation
echo "$(date): Application backup created: $BACKUP_FILE" >> "$BACKUP_DIR/backup.log"

# Keep only last 30 days of backups
find "$BACKUP_DIR" -name "app_backup_*.tar.gz" -mtime +30 -delete
