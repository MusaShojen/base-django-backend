#!/bin/bash

# Database backup script
BACKUP_DIR="{{ app_home }}/backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="db_backup_${DATE}.sql"

# Create backup directory if it doesn't exist
mkdir -p "$BACKUP_DIR"

# Database backup
{% if db_engine == 'postgresql' %}
pg_dump -h {{ db_host }} -U {{ db_user }} -d {{ db_name }} > "$BACKUP_DIR/$BACKUP_FILE"
{% else %}
# SQLite backup
cp "{{ app_home }}/db.sqlite3" "$BACKUP_DIR/db_backup_${DATE}.sqlite3"
{% endif %}

# Compress backup
gzip "$BACKUP_DIR/$BACKUP_FILE"

# Log backup creation
echo "$(date): Database backup created: $BACKUP_FILE.gz" >> "$BACKUP_DIR/backup.log"

# Keep only last 30 days of backups
find "$BACKUP_DIR" -name "db_backup_*.sql.gz" -mtime +30 -delete
